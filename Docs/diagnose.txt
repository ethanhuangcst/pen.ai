Good ‚Äî now we finally have **real error signals** instead of guessing. Let‚Äôs break this down cleanly.

You are failing for **two completely different reasons**:

---

# üö® Problem 1 ‚Äî `qwen-plus` (Baichuan endpoint) ‚Üí 401 Invalid API Key

Your log:

```json
{
  "error": {
    "code": "invalid_api_key",
    "message": "Incorrect API key provided. You can find your API key at https://platform.baichuan-ai.com/console/apikey."
  }
}
```

And the endpoint used:

```
https://api.baichuan-ai.com/v1/chat/completions
```

### üîé This means:

You are NOT calling Qwen.

You are calling **Baichuan AI**.

That endpoint belongs to **Baichuan**, not Qwen.

So either:

* Your DB row for `qwen-plus` is pointing to Baichuan
* Or you mixed providers

---

## ‚úÖ Fix

If this provider is actually:

### üü¢ Qwen (Alibaba DashScope)

Correct endpoint should be:

```
https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

AND payload format is different (NOT OpenAI format).

---

### üü¢ If this is Baichuan

Then:

You must use a Baichuan API key from:

```
https://platform.baichuan-ai.com/console/apikey
```

Your current key is wrong for that provider.

---

# üö® Problem 2 ‚Äî `gpt-4o-mini` ‚Üí Timeouts

You attempted:

```
https://api.openai.com/v1/images/generations
https://api.openai.com/v1/embeddings
https://api.openai.com/v1/chat/completions
```

First two timed out:

```
Error Domain=NSURLErrorDomain Code=-1001 "The request timed out."
```

This is NOT a code bug.

This is:

### üî• Network issue.

Most common causes:

1. Running in China without proxy
2. Firewall blocking api.openai.com
3. DNS blocked
4. Corporate network blocking
5. VPN not configured in macOS system settings

---

## üîç Why Images & Embeddings timeout first?

Because your test payload is:

```swift
{
  "model": provider.defaultModel,
  "messages": [...]
}
```

That payload only works for:

```
/v1/chat/completions
```

When you send that to:

```
/v1/images/generations
```

It may hang or reject.

---

# üí• Major Design Flaw in Your System

You are looping over ALL base URLs:

```swift
for baseURL in baseURLs
```

But your payload is ALWAYS a **chat completion payload**.

So:

| Endpoint               | Compatible? |
| ---------------------- | ----------- |
| /v1/chat/completions   | ‚úÖ Yes       |
| /v1/images/generations | ‚ùå No        |
| /v1/embeddings         | ‚ùå No        |

You should NOT test all endpoints with the same payload.

---

# ‚úÖ Correct Fix (Very Important)

Inside `testConnection()`:

Replace this:

```swift
for baseURL in baseURLs
```

With:

```swift
for baseURL in baseURLs where baseURL.contains("chat/completions")
```

OR better:

Store only ONE test endpoint per provider in DB.

For OpenAI:

```
https://api.openai.com/v1/chat/completions
```

Do NOT store:

* images
* embeddings

Those are different APIs.

---

# üéØ Why GPT is timing out

Most likely:

You are in China or restricted network.

Test this in Terminal:

```bash
curl https://api.openai.com/v1/models
```

If it hangs ‚Üí network block.

Your Swift code is fine for OpenAI.

---

# üß† Summary of What Is Actually Wrong

### ‚ùå qwen-plus

* Wrong endpoint (Baichuan)
* Wrong API key
* Provider misconfigured in DB

### ‚ùå gpt-4o-mini

* Testing wrong endpoints
* Possibly network blocked
* Should only test chat endpoint

---

# üî• Clean Correct Configuration

## For OpenAI (gpt-4o-mini)

DB should contain:

```json
{
  "chat": "https://api.openai.com/v1/chat/completions"
}
```

Auth header:

```
Authorization
```

requires_auth:

```
true
```

default_model:

```
gpt-4o-mini
```

---

## For Baichuan

Endpoint:

```
https://api.baichuan-ai.com/v1/chat/completions
```

Model example:

```
Baichuan2-Turbo
```

Bearer token required.

---

## For Qwen (DashScope)

Endpoint:

```
https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

Auth header:

```
Authorization
```

Value:

```
Bearer YOUR_DASHSCOPE_KEY
```

BUT payload format is different ‚Äî your current parser will fail.

---

# üõ† Immediate Action Plan

1. Fix DB entries:

   * Remove image & embedding endpoints from OpenAI
   * Fix qwen provider endpoint
2. Only test chat endpoint
3. Confirm network access to api.openai.com
4. Use correct API key for each provider

---

# ‚ö†Ô∏è One More Hidden Bug

You are loading provider by:

```sql
SELECT * FROM ai_providers WHERE name = 'gpt-4o-mini'
```

That is wrong design.

`gpt-4o-mini` is a MODEL, not a provider.

Provider should be:

* openai
* baichuan
* dashscope
* deepseek

Then model stored separately.

Right now your architecture couples provider & model incorrectly.

That will cause more bugs later.

---

If you paste:

* Your `ai_providers` table row for:

  * gpt-4o-mini
  * qwen-plus

I‚Äôll give you the exact corrected configuration structure.
